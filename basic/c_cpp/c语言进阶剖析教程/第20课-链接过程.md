# 第20课-链接过程

20-1.c

```c
#include<stdio.h>

extern void print();

extern int sum(int a,int b);

int main(){

	int a = 2,b = 3;
	
	print();
	
	printf("%d\n",sum(a,b));
	return 0;
}
```

lib.c

```c
#include<stdio.h>

void print(){

	printf("hello\n");
};

int sum(int a,int b){
	
	return a + b;
}
```

![%E7%AC%AC20%E8%AF%BE-%E9%93%BE%E6%8E%A5%E8%BF%87%E7%A8%8B%2014c97809f4474342bdd7905e10a66959/Untitled.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111162238851.png)

1、gcc -c lib.c -o lib.o

          编译：生成目标文件

2、ar -q lib.a lib.o

         生成静态文件

3、gcc 20-1.c lib.a -o 20-1.out

         链接生成可执行文件

4、删除 lib.a  仍然成功执行20-1.out

20-2.c

```c
#include <stdio.h>
#include <dlfcn.h>

//extern char* pname();

//extern int pname(int a,int b);

int main(){

	void* pdlib = dlopen("./dlib.so",RTLD_LAZY);//RTLD_LAZY？
	
	char* (*pname)();//char* pname();?
	int (*padd)(int ,int );
	
	if(pdlib != NULL)
	{
		pname = dlsym(pdlib,"name");//seek
		padd = dlsym(pdlib,"add");		
		
		if(pname!=NULL&&padd!=NULL)
		{
			printf("Name:%s\n",pname());
			printf("Result:%d\n",padd(2,3));
		}
		
		dlclose(pdlib);	
	}
	else
	{
		printf("cannot open lib ...\n");
	}
	
	return 0;
}
```

dlib.c

```c
char* name(){

	return "Dynamic Lib\n";
}

int add(int a,int b){
	
	return a + b;
}
```

![%E7%AC%AC20%E8%AF%BE-%E9%93%BE%E6%8E%A5%E8%BF%87%E7%A8%8B%2014c97809f4474342bdd7905e10a66959/Untitled%201.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111162238852.png)

1、编译动态库源码：gcc -m32 -shared dlib.c -o dlib.so//-m32 ?

2、使用动态库编译：gcc  20-2.c -ldl -o 20-2.out

3、执行：./20-2.out    ok

4、删除dlib.so     执行./20-2.out    无法打开动态库

总结：

-静态链接：目标文件直接链接进入可执行程序

        应用：部分软件更新

-动态链接：在程序启动后才动态加载目标文件

        应用：可方便移植的小软件
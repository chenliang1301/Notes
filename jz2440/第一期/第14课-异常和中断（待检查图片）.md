# 第14课-异常和中断

<img src="https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172238549.png" alt="%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled.png" style="zoom: 100%;" />

中断内部机制

编程

1. 使能中断,

start.S

```c
bic r0, r0, #(1<<7) /* 清除I位使能中断 */

bl interrupt_init /* 初始化中断控制器 */
bl key_eint_init /* 初始化按键，设为中断源 */
```

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%201.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172252355.png)

2.初始化中断控制器

bl interrupt_init

3、初始化按键设为中断源

外部中断处理流程

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%202.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172252506.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%203.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172252770.png)

/* config GPIO interrupt pin */

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%204.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172252087.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%205.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172252115.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%206.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253621.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%207.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253070.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%208.png](D:\08 git\notion\all\韦东山\第一期\images\Untitled 8-1636555185888.png)

/* set interrupt touch off mode: Both edge triggered */

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%209.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172257942.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2010.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255541.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2011.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253749.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2012.png](D:\08 git\notion\all\韦东山\第一期\images\Untitled 12-1636555192109.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2013.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253625.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2014.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255785.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2015.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253942.png)

中断与中断控制器之间有个屏蔽寄存器

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2016.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253934.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2017.png](D:\08 git\notion\all\韦东山\第一期\images\Untitled 17.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2018.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253910.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2019.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253211.png)

读取那个中断产生了

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2020.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172256141.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2021.png](D:\08 git\notion\all\韦东山\第一期\images\Untitled 21.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2022.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172253523.png)

/* SRCPND :display which interrupt creat,clear specific bit

- bit0 -- eint0
- bit2 -- eint2
- bit5 -- eint8_23
*/

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2023.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172254803.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2024.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172254324.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2025.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172254989.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2026.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172254467.png)

/* INTNASK :mask which interrupt ,1-masked

- bit0 -- eint0
- bit2 -- eint2
- bit5 -- eint8_23
*/

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2027.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172254911.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2028.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172254793.png)

/* INTPND :display which priority toppest interrupt now,1-asserted

- bit0 -- eint0
- bit2 -- eint2
- bit5 -- eint8_23
*/

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2029.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172256285.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2030.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255780.png)

```c

/* interrrupt 
```

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2031.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255261.png)

---

---

---

---

---

设置异常，中断

---

```c
b halt			 /* vector 0x0c : prefetch aboot */
	b halt			 /* vector 0x10 : data abort */
	b halt			 /* vector 0x14 : reserved */
	ldr pc, irq_addr /* vector 0x18 : irq */
	b halt			 /* vector 0x1c : fiq */
```

异常机制—保存处理恢复

```c
do_irq:
	/* 执行到这里之前:
	 * 1. lr_irq保存有被中断模式中的下一条即将执行的指令的地址
	 * 2. SPSR_irq保存有被中断模式的CPSR
	 * 3. CPSR中的M4-M0被设置为10010, 进入到irq模式
	 * 4. 跳到0x18的地方执行程序 
	 */

	/* sp_irq未设置, 先设置它 */
	ldr sp, =0x33d00000

	/* 保存现场 */
	/* 在irq异常处理函数中有可能会修改r0-r12, 所以先保存 */
	/* lr-4是异常处理完后的返回地址, 也要保存 */
	sub lr, lr, #4
	stmdb sp!, {r0-r12, lr}  
	
	/* 处理irq异常 */
	bl handle_irq_c
	
	/* 恢复现场 */
	ldmia sp!, {r0-r12, pc}^  /* ^会把spsr_irq的值恢复到cpsr里 */
```

bl handle_irq_c——————-跳转到异常处理函数

```c
void handle_irq(void)
{
    /*分辨中断源*/
    int bit = INTOFFSET;
    /* 调用对应的处理函数 */
    if(bit == 0 || bit == 2 || bit == 5) /* eint0*/
    {
        key_einr_irq(bit); /* 处理中断，清中断源 */
    }
       
    /* 清中断 : 从源头开始清 */
    SRCPND = (1<<bit);
    INTPND = (1<<bit);
}
```

---

---

---

---

---

---

---

---

---

---

---

---

—

# 异常核心：

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2032.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255552.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2033.png](D:\08 git\notion\all\韦东山\第一期\images\Untitled 33.png)

**********

********************************************中断处理流程**********************************************

start.c

1、初始化：
      关闭看门狗、设置时钟、设置内存登

2、使能中断

```c
bic r0, r0, #(1<<7)  /* 清除I位, 使能中断 */
```

3、跳转main.c

main.c

1、初始化中断控制器、中断源

2、循环打印串口

```c
int main(void)
{
  led_init();
  interrupt_init();
	key_eint_init();

	puts("\n\rg_A = ");
	printHex(g_A);
	puts("\n\r");

	while (1)
	{
#if 0		
		puts("\n\rg_Char = ");
		printHex(g_Char);
		puts("\n\r");

		puts("\n\rg_Char3 = ");
		printHex(g_Char3);
		puts("\n\r");
#endif
		putchar(g_Char);
		g_Char++;

		putchar(g_Char3);
		g_Char3++;
		delay(1000000);
	}

	
	return 0;
}
```

按下按键，产生中断：跳转到 

start.s 中的 ldr pc ,irq_addr

1、设置栈

2、保存现场

3、恢复现场

```c
do_irq:
	/* 执行到这里之前:
	 * 1. lr_irq保存有被中断模式中的下一条即将执行的指令的地址
	 * 2. SPSR_irq保存有被中断模式的CPSR
	 * 3. CPSR中的M4-M0被设置为10010, 进入到irq模式
	 * 4. 跳到0x18的地方执行程序 
	 */

	/* sp_irq未设置, 先设置它 */
	ldr sp, =0x33d00000

	/* 保存现场 */
	/* 在irq异常处理函数中有可能会修改r0-r12, 所以先保存 */
	/* lr-4是异常处理完后的返回地址, 也要保存 */
	sub lr, lr, #4
	stmdb sp!, {r0-r12, lr}  
	
	/* 处理irq异常 */
	bl handle_irq_c
	
	/* 恢复现场 */
	ldmia sp!, {r0-r12, pc}^  /* ^会把spsr_irq的值恢复到cpsr里 */
```

********************************************中断处理流程**********************************************

# 定时器工作原理

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2034.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255038.png)

# 如何使用

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2035.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172257762.png)

---

---

---

---

操作哪些寄存器

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2036.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255969.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2037.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255657.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2038.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172257216.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2039.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255000.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2040.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255591.png)

![%E7%AC%AC14%E8%AF%BE-%E5%BC%82%E5%B8%B8%E5%92%8C%E4%B8%AD%E6%96%AD%20d80a26484bca421a8b6c59e0815a6a67/Untitled%2041.png](https://cdn.jsdelivr.net/gh/chenliang1301/Images@main/NotesImages/202111172255805.png)

```c
void timer_init(void)
{
    /* 设置TIMER0的时钟 */
    /* Timer input clock Frequency = PCLK / {prescaler value+1} / {divider value}
                                                          = 50 000 000 /(99+1)/16
                                                          = 31250  //1S
        {prescaler value} = 0~255
        {divider value} = 2, 4, 8, 16                                                          
    */
    
    TCFG0  = 99; /* 用于Prescaler0，Prescaler1 */
    TCFG1  &= ~0xf;
    TCFG1  |= 3;     /* MUX0 : 1/16 */
    
    /* 设置TIMER0初值 */

    TCNTB0 = 15625; /* 0.5s中断一次 */
    
    /* 加载初值，启动timer0  */
    TCON  |= (1<<1); /* Update TCNTB0 & TCMPB0 */
    
    /* 设置为自动加载 */
    TCON  &= (1<<1);
    TCON  |= (1<<0)  | (1<<3); /* bit0:start,bit3:auto reload */
    
    /* 设置中断 */
}
```

定义函数指针

```c
typedef void (*irq_func) (int irq);
irq_func irq_array[32];
```

初始化中断

```c
regisrer_irq(5, key_eint_irq);
```